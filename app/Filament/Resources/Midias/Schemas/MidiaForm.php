<?php

namespace App\Filament\Resources\Midias\Schemas;

use App\Models\Parlamentar;
use App\Models\Projeto;
use Filament\Schemas\Schema;
use Filament\Schemas\Components\Tabs;
use Filament\Schemas\Components\Tabs\Tab;
use Filament\Forms\Components\TextInput;
use Filament\Schemas\Components\Utilities\Set;
use Filament\Forms\Components\Textarea;
use Filament\Forms\Components\FileUpload;
use Filament\Forms\Components\Select;
use Filament\Forms\Components\DatePicker;
use Filament\Forms\Components\TimePicker;
use Filament\Forms\Components\TagsInput;
use Filament\Forms\Components\Toggle;
use Filament\Forms\Components\DateTimePicker;
use Illuminate\Support\Str;
use App\Filament\Forms\Components\OptimizedImageUpload;

class MidiaForm
{
    public static function configure(Schema $schema): Schema
    {
        return $schema
            ->components([
                Tabs::make('Dados da M√≠dia')
                    ->tabs([
                        Tab::make('Informa√ß√µes B√°sicas')
                            ->schema([

                                TextInput::make('titulo')
                                    ->required()
                                    ->maxLength(255)
                                    ->live(onBlur: true)
                                    ->afterStateUpdated(
                                        fn(string $operation, $state, Set $set) =>
                                        $operation === 'create' ? $set('slug', Str::slug($state)) : null
                                    )
                                    ->columnSpanFull(),

                                TextInput::make('slug')
                                    ->required()
                                    ->maxLength(255)
                                    ->unique(ignoreRecord: true)
                                    ->columnSpanFull(),

                                Textarea::make('descricao')
                                    ->maxLength(1000)
                                    ->rows(3)
                                    ->columnSpanFull(),

                                OptimizedImageUpload::make('thumbnail')
                                    ->label('Imagem Principal')
                                    ->image()
                                    ->imageEditor()
                                    ->directory('midias/thumbnails')
                                    ->quality(50)
                                    ->showCompressionStats()
                                    ->openable()
                                    ->downloadable()
                                    ->maxSize(3072) // 3MB
                                    ->helperText('Imagem que representa o v√≠deo. Ideal: 1280x720px'),


                                Select::make('tipo')
                                    ->options([
                                        'sessao_ordinaria' => 'üìã Sess√£o Ordin√°ria',
                                        'sessao_extraordinaria' => '‚ö° Sess√£o Extraordin√°ria',
                                        'sessao_solene' => 'üéñÔ∏è Sess√£o Solene',
                                        'audiencia_publica' => 'üë• Audi√™ncia P√∫blica',
                                        'reuniao_comissao' => 'üèõÔ∏è Reuni√£o de Comiss√£o',
                                        'evento_especial' => '‚≠ê Evento Especial',
                                        'solenidade' => 'üéâ Solenidade',
                                        'entrevista' => 'üé§ Entrevista',
                                        'pronunciamento' => 'üí¨ Pronunciamento',
                                        'outros' => 'üìÅ Outros',
                                    ])
                                    ->required(),

                                Select::make('status')
                                    ->options([
                                        'ativo' => '‚úÖ Ativo',
                                        'inativo' => '‚ùå Inativo',
                                        'processando' => '‚è≥ Processando',
                                        'erro' => '‚ùå Erro',
                                    ])
                                    ->required()
                                    ->default('ativo'),
                            ])
                            ->columns(2),

                        Tab::make('Links dos V√≠deos')
                            ->schema([
                                TextInput::make('youtube_url')
                                    ->label('üé• YouTube URL')
                                    ->url()
                                    ->placeholder('https://www.youtube.com/watch?v=VIDEO_ID')
                                    ->columnSpanFull()
                                    ->helperText('O ID do v√≠deo ser√° extra√≠do automaticamente.'),

                                TextInput::make('facebook_url')
                                    ->label('üìò Facebook URL')
                                    ->url()
                                    ->placeholder('https://www.facebook.com/watch/?v=VIDEO_ID'),

                                TextInput::make('instagram_url')
                                    ->label('üì∑ Instagram URL')
                                    ->url()
                                    ->placeholder('https://www.instagram.com/p/POST_ID/'),

                                TextInput::make('link_alternativo')
                                    ->label('üîó Link Alternativo')
                                    ->url()
                                    ->placeholder('Outro player ou plataforma')
                                    ->columnSpanFull(),

                                TextInput::make('duracao_segundos')
                                    ->label('‚è±Ô∏è Dura√ß√£o (segundos)')
                                    ->numeric()
                                    ->helperText('Dura√ß√£o total do v√≠deo em segundos. Ex: 3600 = 1 hora'),

                                TextInput::make('qualidade')
                                    ->label('üé¨ Qualidade')
                                    ->placeholder('Ex: HD, Full HD, 4K')
                                    ->maxLength(50),
                            ])
                            ->columns(2),

                        Tab::make('Data e Local')
                            ->schema([
                                DatePicker::make('data_evento')
                                    ->label('üìÖ Data do Evento')
                                    ->required()
                                    ->default(now()),

                                TimePicker::make('hora_inicio')
                                    ->label('‚è∞ Hora de In√≠cio'),

                                TimePicker::make('hora_fim')
                                    ->label('‚è∞ Hora de Fim'),

                                TextInput::make('local_evento')
                                    ->label('üìç Local do Evento')
                                    ->placeholder('Ex: Plen√°rio da C√¢mara Municipal')
                                    ->columnSpanFull(),

                                TextInput::make('periodo_legislativo')
                                    ->label('üèõÔ∏è Per√≠odo Legislativo')
                                    ->placeholder('Ex: 2021-2024')
                                    ->maxLength(50),
                            ])
                            ->columns(3),

                        Tab::make('Relacionamentos')
                            ->schema([
                                Select::make('parlamentares_presentes')
                                    ->label('üë• Parlamentares Presentes')
                                    ->options(Parlamentar::where('ativo_app', true)->pluck('nome_parlamentar', 'id'))
                                    ->multiple()
                                    ->searchable()
                                    ->columnSpanFull(),

                                Select::make('evento_relacionado_id')
                                    ->label('üìã Evento Relacionado')
                                    ->relationship('eventoRelacionado', 'titulo')
                                    ->searchable()
                                    ->columnSpanFull(),

                                Select::make('projetos_discutidos')
                                    ->label('üìú Projetos Discutidos')
                                    ->options(Projeto::pluck('titulo', 'id'))
                                    ->multiple()
                                    ->searchable()
                                    ->columnSpanFull(),

                                TagsInput::make('tags')
                                    ->label('üè∑Ô∏è Tags')
                                    ->placeholder('Digite e pressione Enter')
                                    ->columnSpanFull(),
                            ]),

                        Tab::make('Configura√ß√µes do App')
                            ->schema([
                                Toggle::make('disponivel_app')
                                    ->label('üì± Dispon√≠vel no App')
                                    ->default(true)
                                    ->helperText('Se a m√≠dia aparece no aplicativo m√≥vel.'),

                                Toggle::make('destaque')
                                    ->label('‚≠ê Destacar')
                                    ->helperText('Aparece em destaque no app.'),

                                TextInput::make('ordem_exibicao')
                                    ->label('üìã Ordem de Exibi√ß√£o')
                                    ->numeric()
                                    ->default(0)
                                    ->helperText('Menor n√∫mero aparece primeiro.'),

                                Textarea::make('observacoes')
                                    ->label('üìù Observa√ß√µes')
                                    ->maxLength(1000)
                                    ->rows(3)
                                    ->columnSpanFull(),
                            ])
                            ->columns(2),

                        Tab::make('SEO e Metadados')
                            ->schema([
                                TextInput::make('meta_title')
                                    ->label('üîç T√≠tulo SEO')
                                    ->maxLength(60)
                                    ->columnSpanFull()
                                    ->helperText('Deixe vazio para usar o t√≠tulo da m√≠dia.'),

                                Textarea::make('meta_description')
                                    ->label('üîç Descri√ß√£o SEO')
                                    ->maxLength(160)
                                    ->rows(3)
                                    ->columnSpanFull()
                                    ->helperText('Deixe vazio para usar a descri√ß√£o.'),

                                TextInput::make('responsavel_upload')
                                    ->label('üë§ Respons√°vel pelo Upload')
                                    ->default(auth()->user()?->name)
                                    ->disabled(),

                                DateTimePicker::make('data_upload')
                                    ->label('üìÖ Data do Upload')
                                    ->default(now())
                                    ->disabled(),
                            ])
                            ->columns(2),
                    ])
                    ->columnSpanFull()
            ]);
    }
}
